# 核心规则（必须遵守）

## 阶段顺序与输出标签

- 顺序：`研究 -> 构思 -> 计划 -> 执行 -> 优化 -> 评审`。
- 每次回复以模式标签开头：`[模式：研究]` / `[模式：构思]` / `[模式：计划]` / `[模式：执行]` / `[模式：优化]` / `[模式：评审]`。
- 进入 `[模式：评审]` 前：必须至少输出一次 `[模式：优化]`（即使无优化也必须说明并落盘，见下方“可追溯性”）。
- 默认自主推进；但从 `[模式：计划]` 进入 `[模式：执行]` 前必须先做“执行前讲解 + 人工确认”门禁，其它确认场景仍按 `references/safety.md` 执行。

## 默认工程原则（简洁/可读性优先）

- 最简单的变更：以整体设计与认知负担为准，而非 diff 最小。
- 不关心迁移：默认不提供迁移/兼容路径（含旧 API 兼容、双写、开关保留）；直接更新调用方保持一致性。
- 可读性优先：允许为清晰结构做更大范围的行为等价重构；若涉及行为变化，必须先写入约束/验收并走确认与验证流程。
- 若需求明确要求兼容/迁移/灰度：将其视为约束写入研究阶段，并在计划中显式列为 AC#/风险/回滚。

## 执行前讲解 + 人工确认门禁（强制）

目标：在真正开始改代码/跑命令之前，让用户充分理解“为什么这么做 + 怎么做 + 如何验收”，并提供一个明确的人工介入点。

强制规则（从 `[模式：计划]` → `[模式：执行]`）：

1. 必须先输出对“构思 + 计划”的讲解（面向用户、可读、可核对），内容至少包含：
   - 选型与取舍：为何选择推荐方案、放弃了什么、关键风险点在哪里。
   - 实施路径：计划步骤如何映射到验收项（AC#）与证据（E#），最小验证集合是什么。
2. 输出“阶段门禁确认块”，并**停止**进入 `[模式：执行]`：
   - 在用户明确回复“是/确认/继续”前，不得开始任何仓库交付物变更（例如 `apply_patch` 修改业务代码），也不得开始执行阶段命令（例如迁移脚本等）。
   - 例外（已预授权，且仅限以下 4 条命令）：允许在门禁确认前自动执行 `pnpm format:check`、`pnpm lint`、`pnpm build`、`pnpm format` 作为预检/验收（仍需在 plan 的命令记录与证据目录留痕）。
   - `.codex/**` 本地产物（计划/证据）允许在此前生成与更新。
3. 用户确认后，才允许进入 `[模式：执行]` 并开始落实变更。

注：该门禁用于“人工介入与对齐”，不替代高风险操作的确认；若 `risk_gate` 判定高风险，仍需按 `references/safety.md` 的危险操作确认流程执行。

## 可追溯性（必须落盘）

- 进入 `[模式：执行]` 后，关键决策、命令与验证结果必须记录到 `.codex/plan/<任务名>.md`（本地产物，gitignored）。
- plan 应包含：证据索引 `E#`、决策记录 `D#`（ADR 字段固定）、验证矩阵（`AC# → 命令 → 证据E#`）。
- `[模式：优化]` 阶段必须在 plan 的 `附录 A. 优化记录（[模式：优化]）` 留痕；无优化也必须写“无 + 原因”。
- 命令输出与差异快照只落盘到 `.codex/evidence/<taskId>/`，plan 正文仅引用路径并给出结论摘要。

## 决策来源优先级与冲突处理（强制）

做任何架构/实现/流程决策时，按以下优先级取证与落地；只有当更高优先级缺失或不适用时才允许下探：

1. 仓库既有约定与代码模式（同类模块的现有实现、目录结构、命名、错误处理、日志、测试方式）
2. `AGENTS.md` 约束（含目录作用域内更近的 `AGENTS.md`）
3. 官方文档与权威资料（优先用 Context7 查询并对齐版本）
4. 经验推断（必须标注为推断，并尽量给出可验证的替代方案）

当来源之间发生冲突或需要偏离既有模式时，必须在 `.codex/plan/<任务名>.md` 的“关键决策”中记录取舍依据：

```md
- 冲突点：<描述>
  - 方案 A（来源）：...
  - 方案 B（来源）：...
  - 最终选择：...
  - 取舍依据：<一致性/风险/可维护性/性能/约束>
  - 验证方式：<如何证明选择不会破坏目标>
```

## Context7 最佳实践溯源门禁（硬规则）

目标：当“仓库既有约定/配置/样本”不足以裁决关键实现或存在争议时，必须可追溯地引用官方/权威最佳实践（优先 Context7）。

强制要求（进入 `[模式：构思]` 时生效）：

1. 必须生成并维护证据 `E5`（Context7）：
   - 默认落盘：`.codex/evidence/<taskId>/context7.md`
   - 内容必须包含：所查库/版本、查询 topic/页面、关键结论摘要、对本仓库的具体约束与落地方式。
2. 允许“不适用”，但必须同时写清：
   - 不适用理由（为何无需外部最佳实践裁决）
   - 替代验证方式（例如：以仓库既有样本/配置为准的证据链，或可回放验证方案）
3. 在 `[模式：评审]` 必须检查该门禁是否满足：
   - `E5` 存在且内容可追溯；或标注“不适用 + 理由 + 替代验证方式”
   - 否则视为未达标（需要补齐 E5 或补齐“不适用”的证据链）

## 获取“仓库既有约定与代码模式”（以事实为准）

- 若存在 `docs/CONVENTIONS.md`：将其视为索引入口（用于快速定位权威来源与同类样本），但不得替代对真实配置/代码的二次核验。
- 若不存在：按以下流程提炼既有模式：
  1. 先运行 `collect_context` 生成/查看项目画像，并从输出的“工程文档入口/关键配置文件/AGENTS 线索”开始定位。
  2. 把“可强制的护栏”作为约定基线：`eslint.config.*`、`tsconfig.json`、`next.config.*`、`package.json scripts`（以及作用域内 `AGENTS.md`）。
  3. 对与任务同类的模块，选 3–5 个邻近样本（同目录/同职责）+ 2–3 个调用方样本，提炼一致模式（命名、导出、错误处理、依赖方向）。
  4. 当样本不一致或需要偏离时，按“来源优先级”决策，并在 plan 记录冲突、取舍依据与验证方式。

## 优化策略（可控）

- 默认仅做**可证明行为等价**的重构。
- 任何可能改变行为或性能/资源特征的优化：必须先给出“基线 + 对比验证方案”，并在确认方案后再动手（验证细则见 `references/validation.md`）。

## MCP 服务调用原则

- 在构思阶段，优先使用 Context7 获取对应问题/模块/技术栈的最佳实践与正确用法。
- 涉及复杂取舍或需要反思校验时，可使用 sequential-thinking 进行多步推理与验证。
