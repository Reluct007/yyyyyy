# 阶段输出模板（固定骨架）

## [模式：研究]

### 需求完整性评分口径（0-10）

- 目标明确性（0-3）：要解决什么问题/实现什么能力
- 预期结果（0-3）：交付物与验收标准是否明确
- 边界范围（0-2）：包含/不包含什么，影响面多大
- 约束条件（0-2）：时间、性能、兼容性、业务限制等

当总分 < 7 时：聚焦缺失维度提出不超过 3 个确认问题，并在用户补充后重新评分。

```md
[模式：研究]
任务：<一句话>

需求完整性：<0-10>
- 目标明确性：x/3（理由…）
- 预期结果：x/3（理由…）
- 边界范围：x/2（理由…）
- 约束条件：x/2（理由…）

项目画像（优先来自 collect_context / docs/CONVENTIONS.md / 关键配置）：
- 技术栈/框架/包管理：...
- 相关模块/入口：...
- 关键护栏（摘要）：<eslint/分层/strict 等>

约束清单：
- ...

风险清单：
- ...

未知项（仅列影响决策/验收者）：
- ...

下一步：进入 [模式：构思] / 提出确认问题（<=3 个）
```

## [模式：构思]

```md
[模式：构思]
目标：<要解决什么>
约束：<来自研究阶段>

工程原则（默认；除非需求显式覆盖，见 `references/core.md`）：
- 最简单的变更（以整体设计/认知负担为准，而非 diff 最小）
- 不做迁移/兼容路径：直接更新调用方
- 可读性优先：必要时接受更大范围改动以换取更清晰结构（仍需验证）

Context7/官方最佳实践对齐（E5，硬门禁）：
- 结论：适用 / 不适用
- 若适用：将查询与结论落盘到 `.codex/evidence/<taskId>/context7.md`，并在 plan 的 E5 引用
  - 库与版本：<library@version>
  - 查询：<context7CompatibleLibraryID> topic=<...> page=<...>
  - 关键结论（摘要）：...
  - 对本仓库的落地约束：...
- 若不适用：必须写清“不适用理由 + 替代验证方式（可回放）”

方案 1：<描述>
- 优点：...
- 风险：...
- 预期改动：<文件/模块级别>

方案 2：<描述>
- 优点：...
- 风险：...
- 预期改动：<文件/模块级别>

推荐：方案 <1/2>
- 取舍依据：<一致性/风险/可维护性/性能/交付周期/约束>
- 需要确认（如有，<=3 个）：...

下一步：进入 [模式：计划]
```

## [模式：计划]

```md
[模式：计划]
选定方案：方案 <1/2>

工程原则（默认）：最简单变更；不做迁移/兼容路径；可读性优先（必要时接受更大范围改动）。

步骤（原子化，可执行）：
1. <文件/函数/逻辑概要>（验收点：...）
2. ...

关键决策（如有）：...
风险与回滚：...

最小验证集合（默认自动跑；以项目 scripts 为准）：
- `<format:check>`（若存在）
- `<lint>`（若存在）
- `<build>`（若存在且变更触及构建/依赖/配置/关键链路）
（提示：允许在阶段门禁确认前自动预检的白名单命令仅限 `pnpm format:check`/`pnpm lint`/`pnpm build`/`pnpm format`。）

需要确认（如有，<=3 个）：...

执行前讲解（必须，面向用户）：
- 构思回顾：为什么选这个方案、放弃了什么、关键风险点是什么
- 计划导览：每一步怎么对应 AC#/E#，最小验证集合怎么跑，回滚点在哪里

阶段门禁（必须）：进入执行阶段前确认
请确认是否继续进入执行阶段？[需要明确的"是"、"确认"、"继续"]

下一步：等待用户确认后进入 [模式：执行]
```

## [模式：执行]

```md
[模式：执行]
里程碑：<完成了什么>
变更摘要：<模块/行为层面>
变更文件：<列出关键文件>

风险复核（risk_gate，如有）：<风险等级/需要确认/最小验证集合>
已执行验证（默认自动跑）：<format:check/lint/build 等> → <结论>

下一步：<要做什么>（如需确认，<=3 个问题）
```

## [模式：优化]

```md
[模式：优化]
范围：仅本次变更相关代码

落盘要求（必须）：
- 在 `.codex/plan/<任务名>.md` 的 `附录 A. 优化记录（[模式：优化]）` 填写本阶段结论与证据引用（无优化也必须写“无”并说明原因）。

行为等价重构（可直接做）：
- ...

性能/资源特征变化（需基线 + 对比验证方案）：
- 基线：<当前测量/命令/指标>
- 对比验证：<如何证明收益/无回归>

行为变化（需确认 + 基线 + 对比验证方案）：
- 变更说明：...
- 基线：...
- 对比验证：...

下一步：进入 [模式：评审]
```

## [模式：评审]

```md
[模式：评审]
对照计划核对：
- [ ] 交付物/验收点：...
- [ ] Context7 门禁：E5 已补齐（或“不适用+理由+替代验证方式”）
- [ ] 优化痕迹：plan `附录 A. 优化记录（[模式：优化]）` 已填写（无则写“无”）

验证结果（来自命令记录）：
- `<命令>` → <结论>

文档/配置同步：
- 更新了哪些文档/配置（如有）：...

风险与后续建议：
- ...
```

## `.codex/plan/<任务名>.md`（可溯源约定）

> 目标：让每个关键结论/决策/验收都有“来源与证据（可回放）”。正文保持短，证据与命令输出只落盘引用。

### 证据索引 E#（强制引用）

- 在 plan 中维护 `E1/E2/...` 的证据清单；所有关键结论/决策/验收判定必须引用 `E#`。
- 证据类型至少覆盖：仓库约定与样本、AGENTS 约束、关键配置护栏、Context7/官方文档、命令输出/日志、git diff 快照。
- 命令输出只落盘到 `.codex/evidence/<taskId>/`，plan 正文仅写“路径 + 结论摘要”。

### 决策记录 D#（ADR 化）

每条关键决策用固定字段落盘，便于复盘：

- 背景 / 备选 / 决策 / 依据（E#）/ 影响 / 验证 / 回滚 / 状态（提议|采纳|废弃）

### 验证矩阵（验收 AC# → 命令 → 证据E#）

- 将“成功标准”拆成 `AC1/AC2/...`；每条 AC 必须映射到“命令 + 证据(E#) + 判定口径”。
- 若涉及“优化/行为变化”：必须先给出 Baseline 与 Compare 的对比验证方案（命令、指标、证据），再动手。

## 预期落盘结构

```text
project/                      # 项目根目录
├── .codex/
│   ├── context.md            # collect_context 输出（本地产物）
│   ├── evidence/             # 证据目录（本地产物，命令输出/差异快照等）
│   │   └── <taskId>/
│   │       ├── risk_gate.txt
│   │       ├── lint.log
│   │       ├── build.log
│   │       └── patch.diff
│   └── plan/
│       └── <任务名>.md       # scaffold_plan 生成并维护（本地产物）
└── README.md
```
