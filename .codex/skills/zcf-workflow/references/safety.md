# 安全与确认（必须）

## 何时请求确认（<= 3 个问题）

默认自主推进；当且仅当满足以下任一条件时，请求用户确认：

- 从 `[模式：计划]` 进入 `[模式：执行]` 前（固定门禁：必须讲解构思 + 计划，并等待确认）。
- 例外：以下 4 条预检/验收命令不需要确认（仅此四个）：`pnpm format:check`、`pnpm lint`、`pnpm build`、`pnpm format`。
- 需求完整性评分 < 7，且缺失信息会影响方案选择或验收标准。
- 存在多方案取舍且无法从代码/约束中推断偏好（例如：一致性 vs 性能、行为变化幅度）。注：默认不做迁移/兼容路径（见 `references/core.md`）；仅当需求明确要求迁移/兼容/灰度时再确认。
- 需要新增/升级关键依赖（尤其是核心框架、构建链路、认证/支付/数据库相关）。
- 变更会影响外部 API/配置/数据结构/权限模型，存在破坏性风险。
- 涉及数据操作、权限/安全边界变化。
- `risk_gate` 判定高风险（`hard` 模式默认阻断）。

## 阶段门禁确认格式（强制：计划 -> 执行）

在进入 `[模式：执行]` 前，先输出并等待用户明确回复“是/确认/继续”：

```
阶段门禁：进入执行阶段前确认
讲解要点（构思 + 计划）：
- <为什么选这个方案/关键取舍>
- <将改哪些模块/预期行为变化>
- <计划步骤如何对应 AC#/E#>
- <最小验证集合/回滚策略概览>

请确认是否继续进入执行阶段？[需要明确的"是"、"确认"、"继续"]
```

说明：
- 该门禁用于“人工介入与对齐”，不等同于“危险操作确认”。
- 门禁确认前允许自动执行预检白名单命令（见上方“例外”），其余命令仍需等待门禁确认。
- 若后续 `risk_gate` 判定高风险，仍必须再走“危险操作确认格式（强制）”，且在未获得确认前不得用 `--force` 放行。

## 危险操作确认格式（强制）

在执行任何高风险操作前，先输出并等待用户明确回复“是/确认/继续”：

```
危险操作检测！
操作类型：[具体操作]
影响范围：[详细说明]
风险评估：[潜在后果]

请确认是否继续？[需要明确的"是"、"确认"、"继续"]
```

## risk_gate 硬拦截规则（强制）

- 默认 `hard`：`risk_gate` 检测到高风险时会以非 0 退出码**阻断**后续自动执行，并输出上述确认块。
- 仅在已获得用户明确确认后，允许使用 `--force` 重新运行 `risk_gate` 放行。
- 放行只代表“允许继续推进”，不替代验证；仍需按 `risk_gate` 给出的“最小验证集合”执行并落盘（见 `references/validation.md`）。

## 高风险操作（示例，非穷举）

- 代码提交/推送：`git commit` / `git push` / `git reset --hard`
- 依赖变更：安装/升级关键依赖、锁文件大范围变化
- 数据操作：迁移/批量更新/删除/重置
- 安全边界：鉴权、RBAC、middleware、敏感 API 契约变更
