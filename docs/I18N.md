# i18n（多语言）规范与维护指南

本文描述本仓库当前 i18n（多语言）实现的“事实标准”与维护流程，目标是降低多人协作下的走样与遗漏成本，并维护一份可持续更新的问题清单。若本文与代码实现不一致，以代码实现为准。

## 1. 单一事实源（SoT）

- 语言配置：`data/i18n.js`（`DEFAULT_LOCALE`、`SUPPORTED_LOCALES`、`NON_DEFAULT_LOCALES`）
- 路由组织：
  - 主路由（含默认语言 `en`）：`app/[locale]/...`（路径前缀 `/{locale}`，例如 `/en/...`、`/fr/...`）
  - 兼容路由（历史英文无前缀）：`app/(site)/...`（仅用于产出旧路径静态页；平台侧通过 `public/_redirects` 301 → `/en/...`）
- UI 字典：`locales/*.js`，由 `lib/i18n.js` 聚合为 `getTranslations(locale)`
- 语言上下文与切换：`lib/language-context.js`（`usePathname()` 解析 locale，`router.push()` 进行切换）
- 内容翻译：
  - 产品/分类数据：`data/auto-translate.js`（基于映射表的“整句/整段匹配”翻译）
  - 政策/FAQ：`data/content.js`（按 locale 返回静态 HTML 字符串）
- i18n SEO（canonical/hreflang/sitemap）：见 `docs/SEO.md`（实现入口：`lib/hreflang.js`、`app/sitemap.js`）
- Workers（API）返回文案：当前为英文固定字符串（见 `workers/src/handlers/contact.js`、`workers/src/handlers/subscribe.js`），前端 toast 直接展示 `msg`

## 2. 路由与默认语言策略（方案 B：已采纳）

- 所有语言统一使用 `/{locale}` 前缀：例如 `/en/collection/`、`/fr/product/<slug>/`
- 根路径 `/` 通过平台侧重定向到默认语言：`/` → `/en/`（静态导出下不可依赖 middleware）
- `app/[locale]/layout.js` 使用 `getSupportedLocales()` 生成静态参数，覆盖所有语言（包含 `/en/...`）

## 3. 文案/内容的翻译来源分层（当前现状）

当前仓库并非“单一 i18n 框架”实现，而是多种来源并存：

1) UI 字典（推荐优先使用）
- 位置：`locales/*.js`
- 读取：`lib/i18n.js#getTranslations(locale)`
- 使用：通过 `useLanguage()` 取得 `translations`（例如 Navbar/Footer/Hero/SubscribeForm 等）

2) 页面/组件内的局部映射（高维护成本）
- 特征：组件内部定义 `xxxTranslations` 对象做全文匹配（例如 `app/[locale]/contact/contact-client.js`）
- 风险：原文变更会导致翻译失效且难以全局审计；容易出现与 `locales/*` 重复/冲突

3) 产品/分类“自动翻译”
- 位置：`data/auto-translate.js`
- 机制：`translateText(text, locale)` 通过映射表做“整句/整段匹配”，未命中则回退原文
- 使用点：`app/[locale]/collection/page.js`、`app/[locale]/product/[slug]/page.js` 等

4) 静态政策/FAQ HTML
- 位置：`data/content.js`
- 使用点：`app/[locale]/privacy-policy/page.js`、`app/[locale]/terms-of-service/page.js` 等

5) SEO Metadata 文案
- 入口：`lib/metadata-translations.js#getSeoMeta(pageKey, locale)`
- 备注：当前该模块存在“翻译不可达/品牌文案残留”等问题，见下文问题清单

## 4. 维护流程（新增语言/新增文案）

### 4.1 新增语言（按当前实现必须改动的点）

1. `data/i18n.js`：加入新语言 code 到 `SUPPORTED_LOCALES`
2. `locales/<code>.js`：新增 UI 字典文件
3. `lib/i18n.js`：新增 import 并加入 `translations` map
4. `components/features/language-switcher.js`：加入语言列表项（展示名/flag）
5. `app/[locale]/layout.js`：更新 `localeMap`（OG locale，例如 `it_IT`）
6. `data/content.js`：为政策/FAQ 补齐该语言的静态内容（或明确回退策略）
7. `data/auto-translate.js`：补齐分类/产品/通用文本映射（或明确回退策略）
8. Workers：如希望 API toast 文案也本地化，需要明确“前端传 locale / 后端返回本地化 msg”的协议（当前未实现）

验证建议（本地/CI 对齐）：
- `pnpm lint`
- `pnpm build`（会在构建产物中生成 `sitemap.xml`/`robots.txt`）
- 静态产物抽查：`out/<locale>/` 是否存在且页面内容是否为目标语言（对静态导出尤其重要）

### 4.2 新增/修改 UI 文案

- 优先在 `locales/en.js` 增加 key，并同步补齐其他语言文件
- 避免在页面/组件内新增“整句匹配”的翻译映射（除非明确为短期 workaround，并记录在问题清单中）

## 5. 问题清单（已知问题/待修复）

问题清单已迁移到 `docs/todo-list.md`（作为权威清单/单一事实源）。本文仅保留实现现状、维护流程与 next-intl 接入建议，避免问题列表重复维护导致走样。

## 6. 推荐的修复优先级（建议）

1. 先修复 URL/路由一致性（I18N-001），避免用户与爬虫落到 404
2. 解决静态导出下的首屏语言一致性（I18N-002），否则“翻译存在但不可被 SEO/首屏稳定消费”
3. 补齐关键转化链路（表单/订阅/导航）语言传递（I18N-003、I18N-008）
4. 最后再收敛翻译体系与 SEO 细节（I18N-004~I18N-007、I18N-009）

## 7. next-intl 接入建议（静态导出）

结论：可行，但必须规避 middleware/rewrites 依赖，并把 locale 作为“路由参数 + 静态枚举”的一等公民。

关键约束（与 `output: "export"` 对齐）：
- 不依赖 middleware 做 locale negotiation（静态导出下不会运行）
- 统一 `/{locale}` 前缀（等价 `localePrefix: "always"`），并让 `/` 平台侧重定向到 `/en/`
- 在 `app/[locale]/layout.js` 中使用 `generateStaticParams` 枚举所有语言；接入 next-intl 后需调用 `setRequestLocale(locale)` 以保持静态渲染

推荐迁移路径（避免“大爆炸”）：
1. 先把 UI 文案的单一事实源收敛为 `locales/en.js`（或迁移为 JSON/ICU messages），并用脚本/翻译 Skill 生成其它语言文件
2. 引入 next-intl 后：
   - 在 `app/[locale]/layout.js` 加载 messages，使用 `NextIntlClientProvider` 提供上下文
   - 逐步把 `useLanguage().translations` 改为 `useTranslations()`（先从 Navbar/Footer/CTA 等高频组件开始）
   - 待迁移完成后再移除 `LanguageProvider` 与散落的“整句匹配”映射（I18N-007）
3. 内容层（产品/政策）建议独立治理：
   - 产品/分类：优先修复 slug/路由一致性（I18N-001），再考虑是否要把“标题/描述”纳入 messages 或维持数据层翻译
   - 政策/FAQ：建议以“内容文件 per locale”维护（或 MD/MDX），不要混进 UI 字典
