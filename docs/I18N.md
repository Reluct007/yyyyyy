# i18n（多语言）规范与维护指南

本文描述本仓库当前 i18n（多语言）实现的“事实标准”与维护流程，目标是降低多人协作下的走样与遗漏成本，并维护一份可持续更新的问题清单。若本文与代码实现不一致，以代码实现为准。

## 1. 单一事实源（SoT）

- 语言配置：`data/i18n.js`（`DEFAULT_LOCALE`、`SUPPORTED_LOCALES`、`NON_DEFAULT_LOCALES`）
- 路由组织：
  - 默认语言（`en`）：`app/(site)/...`（无前缀）
  - 非默认语言：`app/[locale]/...`（路径前缀 `/{locale}`）
- UI 字典：`locales/*.js`，由 `lib/i18n.js` 聚合为 `getTranslations(locale)`
- 语言上下文与切换：`lib/language-context.js`（`usePathname()` 解析 locale，`router.push()` 进行切换）
- 内容翻译：
  - 产品/分类数据：`data/auto-translate.js`（基于映射表的“整句/整段匹配”翻译）
  - 政策/FAQ：`data/content.js`（按 locale 返回静态 HTML 字符串）
- i18n SEO（canonical/hreflang/sitemap）：见 `docs/SEO.md`（实现入口：`lib/hreflang.js`、`scripts/generate-sitemap.mjs`）
- Workers（API）返回文案：当前为英文固定字符串（见 `workers/src/handlers/contact.js`、`workers/src/handlers/subscribe.js`），前端 toast 直接展示 `msg`

## 2. 路由与默认语言策略（当前实现）

- 默认语言 `en` 不使用 `/en` 前缀：例如 `/collection/`、`/product/<slug>/`
- 非默认语言使用 `/{locale}` 前缀：例如 `/fr/collection/`、`/fr/product/<slug>/`
- `app/[locale]/layout.js` 使用 `getNonDefaultLocales()` 生成静态参数，仅生成非默认语言的路径（不会生成 `/en/...`）

## 3. 文案/内容的翻译来源分层（当前现状）

当前仓库并非“单一 i18n 框架”实现，而是多种来源并存：

1) UI 字典（推荐优先使用）
- 位置：`locales/*.js`
- 读取：`lib/i18n.js#getTranslations(locale)`
- 使用：通过 `useLanguage()` 取得 `translations`（例如 Navbar/Footer/Hero/SubscribeForm 等）

2) 页面/组件内的局部映射（高维护成本）
- 特征：组件内部定义 `xxxTranslations` 对象做全文匹配（例如 `app/[locale]/contact/contact-client.js`）
- 风险：原文变更会导致翻译失效且难以全局审计；容易出现与 `locales/*` 重复/冲突

3) 产品/分类“自动翻译”
- 位置：`data/auto-translate.js`
- 机制：`translateText(text, locale)` 通过映射表做“整句/整段匹配”，未命中则回退原文
- 使用点：`app/[locale]/collection/page.js`、`app/[locale]/product/[slug]/page.js` 等

4) 静态政策/FAQ HTML
- 位置：`data/content.js`
- 使用点：`app/[locale]/privacy-policy/page.js`、`app/[locale]/terms-of-service/page.js` 等

5) SEO Metadata 文案
- 入口：`lib/metadata-translations.js#getSeoMeta(pageKey, locale)`
- 备注：当前该模块存在“翻译不可达/品牌文案残留”等问题，见下文问题清单

## 4. 维护流程（新增语言/新增文案）

### 4.1 新增语言（按当前实现必须改动的点）

1. `data/i18n.js`：加入新语言 code 到 `SUPPORTED_LOCALES`
2. `locales/<code>.js`：新增 UI 字典文件
3. `lib/i18n.js`：新增 import 并加入 `translations` map
4. `components/features/language-switcher.js`：加入语言列表项（展示名/flag）
5. `app/[locale]/layout.js`：更新 `localeMap`（OG locale，例如 `it_IT`）
6. `data/content.js`：为政策/FAQ 补齐该语言的静态内容（或明确回退策略）
7. `data/auto-translate.js`：补齐分类/产品/通用文本映射（或明确回退策略）
8. Workers：如希望 API toast 文案也本地化，需要明确“前端传 locale / 后端返回本地化 msg”的协议（当前未实现）

验证建议（本地/CI 对齐）：
- `pnpm lint`
- `pnpm build`（会同时生成 `public/sitemap.xml`）
- 静态产物抽查：`out/<locale>/` 是否存在且页面内容是否为目标语言（对静态导出尤其重要）

### 4.2 新增/修改 UI 文案

- 优先在 `locales/en.js` 增加 key，并同步补齐其他语言文件
- 避免在页面/组件内新增“整句匹配”的翻译映射（除非明确为短期 workaround，并记录在问题清单中）

## 5. 问题清单（已知问题/待修复）

约定：严重度仅用于排序（P0 最高），不等同于“必须立刻修复”。状态默认 `OPEN`，修复后将其标记为 `DONE` 并保留简短结论。

| ID | 严重度 | 状态 | 问题 | 影响范围/现象 | 证据（代码位置） |
|---|---|---|---|---|---|
| I18N-001 | P0 | OPEN | 分类 slug 与翻译冲突导致 404 | `/[locale]/collection/` 列表页使用“翻译后的分类标题”生成 slug，路由静态参数与 sitemap 使用“英文标题”生成 slug，点击分类易跳到不存在路径 | `app/[locale]/collection/page.js`、`app/[locale]/collection/[slug]/page.js`、`scripts/generate-sitemap.mjs` |
| I18N-002 | P0 | OPEN | 首屏/静态 HTML 语言不可信（静态导出风险） | `LanguageProvider` 初始 locale 永远为 `en`，挂载后才根据 pathname 修正；静态导出与爬虫/无 JS 访问可能看到英文或出现闪烁 | `lib/language-context.js`、`components/layout/root-chrome.js` |
| I18N-003 | P1 | OPEN | 表单文案未随语言切换 | 多处使用 `<ContactForm />` 未传 locale，导致非英文页面仍显示英文表单文案 | `components/features/navbar.js`、`app/[locale]/contact/contact-client.js`、`components/features/contact-form.js` |
| I18N-004 | P1 | OPEN | `getSeoMeta()` 翻译逻辑不可达 + 品牌残留 | `getSeoMeta()` 优先返回 `seoOverrides`，导致 `seoTranslations` 基本不会生效；并残留 “Labubu Wholesale” 等与当前站点不一致文案 | `lib/metadata-translations.js` |
| I18N-005 | P2 | OPEN | 多语言产品页 alternates/hreflang 不完整 | `/[locale]/product/[slug]` metadata 仅设置 canonical，不提供 `alternates.languages` | `app/[locale]/product/[slug]/page.js` |
| I18N-006 | P2 | OPEN | JSON-LD / breadcrumb URL 未完全本地化 | 部分结构化数据与 breadcrumb 仍指向根路径或未带 locale 前缀 | `app/[locale]/layout.js`、`app/[locale]/product/[slug]/page.js` |
| I18N-007 | P2 | OPEN | 翻译来源分散且大量“整句匹配” | 同一文案可能在 `locales/*`、页面内映射、`data/auto-translate.js` 多处维护；原文微调会导致翻译失效且难以发现 | `data/auto-translate.js`、`app/[locale]/contact/contact-client.js`、`app/[locale]/about/about-client.js` 等 |
| I18N-008 | P3 | OPEN | Workers API 返回 msg 不本地化 | `msg` 为英文固定字符串；前端 toast 直接展示，非英文用户看到英文提示 | `workers/src/handlers/contact.js`、`workers/src/handlers/subscribe.js`、`components/features/contact-form.js`、`components/features/subscribe-form.js` |
| I18N-009 | P3 | OPEN | UI 文案覆盖不完整（硬编码英文） | 存在硬编码英文小标题/按钮文案，导致页面“混语” | 例如 `components/features/header.js`（`Features:`）等 |

## 6. 推荐的修复优先级（建议）

1. 先修复 URL/路由一致性（I18N-001），避免用户与爬虫落到 404
2. 解决静态导出下的首屏语言一致性（I18N-002），否则“翻译存在但不可被 SEO/首屏稳定消费”
3. 补齐关键转化链路（表单/订阅/导航）语言传递（I18N-003、I18N-008）
4. 最后再收敛翻译体系与 SEO 细节（I18N-004~I18N-007、I18N-009）
